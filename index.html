<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>MastoSwipe</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<style>
:root{ --bg1:#fdfdfd;--bg2:#f4f4f6;--card:#ffffffee;--accent:#0ea5e9;--txt:#1e293b;--sub:#64748b;--nav:66px }
*{box-sizing:border-box;margin:0;font-family:'Inter',sans-serif;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--txt);display:flex;flex-direction:column;overscroll-behavior:none}
main{flex:1;position:relative;overflow:hidden}
nav{position:fixed;bottom:0;width:100%;height:var(--nav);display:flex;background:#fff;border-top:1px solid #e2e8f0;backdrop-filter:blur(10px);z-index:10}
nav button{flex:1;background:none;border:0;color:var(--sub);display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:.78rem;gap:.2rem;cursor:pointer}
nav button.active{color:var(--accent)}
nav svg{width:24px;height:24px}
/* Card */
.card{position:absolute;inset:0;margin:14px 14px calc(var(--nav)+20px);border-radius:18px;background:var(--card);box-shadow:0 8px 36px rgba(0,0,0,.10);overflow:hidden;display:flex;flex-direction:column;transition:transform .35s cubic-bezier(.22,.61,.36,1)}
.card img{width:100%;max-height:44vh;object-fit:cover}
.c-body{padding:1.4rem 1.3rem 3.6rem;overflow:auto}
.card h2{font-size:1.2rem;margin-bottom:.55rem;color:var(--accent)}
.card p{font-size:1rem;line-height:1.5}
.like{position:absolute;bottom:2rem;right:1.9rem;width:54px;height:54px;border-radius:50%;border:2px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:1.45rem;background:#fff;color:var(--accent);box-shadow:0 4px 12px rgba(0,0,0,.12)}
.like.liked{background:var(--accent);color:#fff}
.badge{position:absolute;top:.8rem;right:1rem;font-size:.78rem;color:var(--sub)}
.section{padding:1.3rem 1rem 2.8rem}
.tag,.acct{display:inline-block;background:#e2e8f0;margin:.35rem .5rem .35rem 0;padding:.5rem .9rem;border-radius:9999px;font-size:.85rem;color:#334155}
input,button.set{width:100%;padding:.75rem;border-radius:10px;font-size:.9rem;margin-bottom:1rem;border:1px solid #e2e8f0}
button.set{border:0;font-weight:600;cursor:pointer;transition:filter .2s}
#btnConnect{background:var(--accent);color:#fff}
#btnExport{background:#e2e8f0;color:#1e293b}
#btnLogout{background:#ef4444;color:#fff}
#btnReset{background:#fbbf24;color:#1e293b}
.fade{animation:f .35s ease}@keyframes f{0%{opacity:0;transform:scale(.94)}100%{opacity:1}}
</style>
</head>
<body>

<main id="view"></main>
<nav>
  <button data-tab="home" class="active"><i data-lucide="compass"></i><span>Home</span></button>
  <button data-tab="swipe"><i data-lucide="layout"></i><span>Swipe</span></button>
  <button data-tab="settings"><i data-lucide="settings"></i><span>Settings</span></button>
</nav>

<script type="module">
lucide.createIcons();

/* Storage Keys */
const LS={i:'m_i',c:'m_c',s:'m_s',t:'m_t',v:'m_v',in:'m_int',pr:'m_pref'};
let inst=localStorage.getItem(LS.i)||'',cid=localStorage.getItem(LS.c)||'',sec=localStorage.getItem(LS.s)||'',tok=localStorage.getItem(LS.t)||'';
let posts=[],idx=0,next=null;
const inter=JSON.parse(localStorage.getItem(LS.in)||'{}');
const prefs=JSON.parse(localStorage.getItem(LS.pr)||'{"tags":{},"accounts":{}}');
const save=()=>{localStorage.setItem(LS.in,JSON.stringify(inter));localStorage.setItem(LS.pr,JSON.stringify(prefs));};

const $=q=>document.querySelector(q);
const rnd=()=>crypto.randomUUID().replace(/-/g,'');
const sha=async s=>btoa(String.fromCharCode(...new Uint8Array(await crypto.subtle.digest('SHA-256',new TextEncoder().encode(s))))).replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_');
const now=()=>Date.now(),hrs=t=>(now()-t)/3.6e6;
function ensure(id){if(!inter[id])inter[id]={v:0,c:0,l:0,d:0};}
function score(p){ensure(p.id);const i=inter[p.id],pop=Math.log10(1+p.favourites_count+p.reblogs_count),dec=-.08*hrs(new Date(p.created_at)),tag=(p.tags||[]).reduce((s,t)=>s+(prefs.tags[t.name]||0)*.5,0),acc=(prefs.accounts[p.account.id]||0)*1.5;return i.c*3+i.v+i.d*.15+i.l*5+pop+tag+acc+dec;}
async function api(path,m='GET'){const u=path.startsWith('http')?path:inst+path;const r=await fetch(u,{method:m,headers:{Authorization:`Bearer ${tok}`}});if(!r.ok)throw r;if(u.includes('/timelines/home')){const l=r.headers.get('Link');next=null;if(l){const m=l.match(/<([^>]+)>; rel=\"next\"/);if(m)next=m[1];}}return r.json();}
function merge(a){a.forEach(p=>{if(!posts.some(x=>x.id===p.id)){posts.push(p);ensure(p.id);}});posts.sort((a,b)=>score(b)-score(a));}

let tab='home';const view=$('#view');
document.querySelectorAll('nav button').forEach(b=>b.onclick=()=>{if(b.dataset.tab===tab)return;document.querySelectorAll('nav button').forEach(x=>x.classList.toggle('active',x===b));tab=b.dataset.tab;render();});

function home(){
  const sec=document.createElement('div');sec.className='section';
  sec.innerHTML='<h3 style="font-weight:600;margin-bottom:.9rem">Top-#Tags</h3>';
  Object.entries(prefs.tags).sort((a,b)=>b[1]-a[1]).slice(0,8).forEach(([t])=>{
    const s=document.createElement('span');s.className='tag';s.textContent='#'+t;sec.append(s);
  });
  const ac=document.createElement('div');ac.innerHTML='<h3 style="font-weight:600;margin:1.6rem 0 .9rem">Top-Accounts</h3>';
  Object.entries(prefs.accounts).sort((a,b)=>b[1]-a[1]).slice(0,6).forEach(([id])=>{
    const a=document.createElement('span');a.className='acct';a.textContent=id;ac.append(a);
  });
  const liked=document.createElement('div');liked.innerHTML='<h3 style="font-weight:600;margin:1.6rem 0 .9rem">Meist geliked / gelesen</h3>';
  Object.entries(inter).filter(([,v])=>v.l||v.d>2).sort(([,a],[,b])=> (b.l*5+b.d)-(a.l*5+a.d)).slice(0,6).forEach(([id])=>{
    const s=document.createElement('span');s.className='tag';s.textContent=id;liked.append(s);
  });
  view.append(sec,ac,liked);
}
function swipe(){
  const deck=document.createElement('div');deck.style.height='100%';view.append(deck);
  const card=(p,off)=>{
    const el=document.createElement('div');el.className='card fade';el.style.transform=`translateX(${off*100}%)`;
    if(p.media_attachments?.[0]?.type==='image'){const i=document.createElement('img');i.src=p.media_attachments[0].preview_url;el.append(i);}
    const b=document.createElement('div');b.className='c-body';b.innerHTML=`<h2>${p.account.display_name||p.account.acct}</h2><p>${p.content.replace(/<[^>]+>/g,'')}</p>`;el.append(b);
    const like=document.createElement('button');like.className='like';like.textContent='❤';if(inter[p.id].l)like.classList.add('liked');like.onclick=e=>{e.stopPropagation();toggleLike(p,like);};el.append(like);
    const badge=document.createElement('div');badge.className='badge';badge.textContent=`${idx+1}/${posts.length}`;el.append(badge);
    el.onclick=()=>location.hash='#'+p.id;
    el.ondblclick=e=>{toggleLike(p,like);};
    return el;
  };
  const draw=()=>{deck.innerHTML='';if(!posts.length)return;const l=posts[idx-1],c=posts[idx],r=posts[idx+1];if(l)deck.append(card(l,-1));deck.append(card(c,0));if(r)deck.append(card(r,1));};
  let sx=null,sy=null,dx=0,dy=0;
  deck.addEventListener('pointerdown',e=>{sx=e.clientX;sy=e.clientY;deck.setPointerCapture(e.pointerId);});
  deck.addEventListener('pointermove',e=>{
    if(sx===null)return;dx=e.clientX-sx;dy=e.clientY-sy;
    deck.childNodes.forEach((c,i)=>{const baseX=(i-(deck.childNodes.length===3?1:0))*100,constY=0;
      c.style.transition='none';
      c.style.transform=`translate(${baseX+dx/innerWidth*100}%,${constY+dy/innerHeight*100}%)`;
    });
  });
  deck.addEventListener('pointerup',()=>{
    if(sx===null)return;
    const hor=Math.abs(dx)>Math.abs(dy);
    const threshX=innerWidth*0.22,threshY=innerHeight*0.18;
    if(hor){
      if(dx<-threshX&&idx<posts.length-1){idx++;if(posts.length-idx<6)loadMore();}
      else if(dx>threshX&&idx>0){idx--;}
    }else{
      if(dy<-threshY&&idx<posts.length-1){idx++;if(posts.length-idx<6)loadMore();}
      else if(dy>threshY&&idx>0){idx--;}
    }
    sx=sy=dx=dy=null;draw();
  });
  window.onhashchange=()=>{const id=location.hash.slice(1);if(!id){draw();return;}const p=posts.find(x=>x.id==id);if(!p){draw();return;}deck.innerHTML='';const d=document.createElement('div');d.className='card fade';d.innerHTML=`<div class="c-body"><h2>${p.account.display_name||p.account.acct}</h2><p>${p.content}</p></div>`;d.style.overflowY='auto';deck.append(d);};
  draw();
}
function settings(){
  const s=document.createElement('div');s.className='section';
  s.innerHTML=`<input id="inst" placeholder="https://mastodon.social" value="${inst}">
    <button class="set" id="btnConnect">${tok?'Re-Login':'Connect'}</button>
    <button class="set" id="btnLogout" ${tok?'':'disabled'}>Disconnect</button>
    <button class="set" id="btnExport" ${posts.length?'':'disabled'}>Export Data</button>
    <button class="set" id="btnReset">Reset Stats</button>`;
  view.append(s);
  $('#btnConnect').onclick=startOAuth;
  $('#btnLogout').onclick=()=>{localStorage.removeItem(LS.t);tok='';posts=[];idx=0;alert('logged out');render();};
  $('#btnExport').onclick=()=>{const b=new Blob([JSON.stringify({inter,prefs},null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='masto-data.json';a.click();URL.revokeObjectURL(u);};
  $('#btnReset').onclick=()=>{if(confirm('Alle Tracking-Daten löschen?')){Object.keys(inter).forEach(k=>delete inter[k]);Object.keys(prefs.tags).forEach(k=>delete prefs.tags[k]);Object.keys(prefs.accounts).forEach(k=>delete prefs.accounts[k]);save();render();}};
}
async function toggleLike(p,btn){ensure(p.id);const liked=!!inter[p.id].l;await api(`/api/v1/statuses/${p.id}/${liked?'unfavourite':'favourite'}`,'POST');inter[p.id].l=liked?0:1;btn.classList.toggle('liked');prefs.accounts[p.account.id]=(prefs.accounts[p.account.id]||0)+(liked?-1:1);save();}
async function init(){const j=await api('/api/v1/timelines/home?limit=60');merge(j);render();}
async function loadMore(){if(!next)return;const j=await api(next);merge(j);}
async function auto(){if(!tok)return;try{const fresh=await api(`/api/v1/timelines/home?limit=40&since_id=${posts[0]?.id||''}`);if(fresh.length){merge(fresh);idx=0;tab!=='swipe'&&render();}}catch{}finally{setTimeout(auto,90000);}}

/* OAuth */
async function startOAuth(){
  inst=$('#inst').value.trim().replace(/\/$/,'');if(!inst)return;
  localStorage.setItem(LS.i,inst);
  if(!cid){const app=await fetch(inst+'/api/v1/apps',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({client_name:'MastoSwipe',redirect_uris:location.origin+location.pathname,scopes:'read write:statuses'})}).then(r=>r.json());cid=app.client_id;sec=app.client_secret;localStorage.setItem(LS.c,cid);localStorage.setItem(LS.s,sec);}
  const ver=rnd(),chal=await sha(ver);localStorage.setItem(LS.v,ver);
  const a=new URL(inst+'/oauth/authorize');a.searchParams.set('response_type','code');a.searchParams.set('client_id',cid);a.searchParams.set('redirect_uri',location.origin+location.pathname);a.searchParams.set('scope','read write:statuses');a.searchParams.set('code_challenge',chal);a.searchParams.set('code_challenge_method','S256');location.href=a.toString();
}
(async()=>{
  const sp=new URLSearchParams(location.search);
  if(sp.has('code')){inst=localStorage.getItem(LS.i);cid=localStorage.getItem(LS.c);const ver=localStorage.getItem(LS.v);const body=new URLSearchParams({grant_type:'authorization_code',client_id:cid,code:sp.get('code'),redirect_uri:location.origin+location.pathname,code_verifier:ver});if(sec)body.append('client_secret',sec);const t=await fetch(inst+'/oauth/token',{method:'POST',body}).then(r=>r.json());tok=t.access_token;localStorage.setItem(LS.t,tok);history.replaceState({},'',location.pathname);}
})();

function render(){view.innerHTML='';if(tab==='home')home();if(tab==='swipe')swipe();if(tab==='settings')settings();}
if(tok&&inst){init();auto();}else render();
</script>
</body>
</html>
